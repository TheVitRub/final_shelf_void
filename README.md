# Система мониторинга наполнения полок

Система для автоматического мониторинга наполнения полок с использованием компьютерного зрения и YOLO модели.

## Описание проекта

Проект представляет собой систему мониторинга, которая:
- Подключается к IP-камерам через RTSP протокол
- Использует обученную YOLO модель для детекции пустых мест на полках
- Вычисляет процент наполнения полок на основе площади обнаруженных объектов
- Визуализирует результаты в реальном времени
- Поддерживает работу с несколькими камерами одновременно

## Структура проекта

```
final_void_shelf/
├── MVP/                          # Основной модуль приложения
│   ├── main.py                   # Главный скрипт запуска системы
│   ├── config.py                 # Конфигурационные параметры
│   ├── camera/                   # Модуль работы с камерами
│   │   └── camera.py             # Класс для подключения к IP-камерам
│   ├── area_calculation/         # Модуль расчета площади
│   │   ├── area_calculation.py   # Основной класс для расчета наполнения
│   │   └── calculations.py       # Вспомогательные математические функции
│   ├── show_picture/             # Модуль визуализации
│   │   └── show_picture.py       # Класс для отображения результатов
│   ├── track/                    # Модуль трекинга объектов
│   │   └── track.py              # Класс для отслеживания объектов
│   └── outline_the_shelves/     # Модуль калибровки полок
│       └── calibrate_shelf_coordinates.py  # Инструмент для определения координат полок
├── learning/                     # Модуль обучения модели
│   ├── 1.prepare_yolo_dataset.py # Подготовка датасета для YOLO
│   ├── 2.fix_train_txt.py       # Исправление train.txt и val.txt
│   ├── 3.fix_dataset_paths.py   # Преобразование путей в абсолютные
│   ├── 4.learning.ipynb         # Jupyter notebook для обучения модели
│   └── dataset/                  # Датасет для обучения
│       ├── images/               # Изображения
│       ├── labels/               # Аннотации YOLO
│       ├── train.txt            # Список обучающих изображений
│       ├── val.txt              # Список валидационных изображений
│       └── data.yaml            # Конфигурация датасета
├── test.py                       # Тестовый скрипт для проверки системы
└── requaerments.txt             # Зависимости проекта
```

## Установка

### Требования

- Python 3.8+
- CUDA (опционально, для GPU ускорения)

### Установка зависимостей

```bash
pip install -r requaerments.txt
```

Основные зависимости:
- `ultralytics` - библиотека для работы с YOLO моделями
- `opencv-python` - обработка изображений и видео
- `numpy` - численные вычисления
- `matplotlib` - визуализация
- `PIL` (Pillow) - работа с изображениями
- `python-dotenv` - загрузка переменных окружения

## Настройка

### 1. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
CAMERA_IP=192.168.1.100
CAMERA_PORT=554
CAMERA_LOGIN=admin
CAMERA_PASSWORD=password
CAMERA_STREAM_PATH=/h264
```

### 2. Настройка конфигурации

Отредактируйте `MVP/config.py`:

```python
YOLO_MODEL = 'my_best-shelf-void-model.pt'  # Путь к модели
CONFIDENCE_THRESHOLD = 0.25                   # Порог уверенности
DETECTION_IMG_SIZE = 640                      # Размер изображения для детекции
SKIP_FRAMES = 7                               # Пропуск кадров для оптимизации
MAX_DISPLAY_WIDTH = 2000                      # Максимальная ширина окна
```

### 3. Подготовка координат полок

Используйте инструмент калибровки для определения координат полок:

```bash
python MVP/outline_the_shelves/calibrate_shelf_coordinates.py
```

Или создайте JSON файл вручную:

```json
{
  "image_path": "path/to/image.jpg",
  "shelves": [
    [x1, y1, x2, y2],
    [x1, y1, x2, y2]
  ],
  "image_size": [width, height]
}
```

## Использование

### Запуск основной системы

```bash
python MVP/main.py
```

### Тестирование системы

```bash
python test.py
```

### Обучение модели

1. Подготовьте датасет:
```bash
python learning/1.prepare_yolo_dataset.py
```

2. Исправьте пути в train.txt и val.txt:
```bash
python learning/2.fix_train_txt.py
python learning/3.fix_dataset_paths.py
```

3. Запустите обучение в Jupyter notebook:
```bash
jupyter notebook learning/4.learning.ipynb
```

## Основные компоненты

### Camera (MVP/camera/camera.py)

Класс для подключения к IP-камерам через RTSP:
- Автоматическое переподключение при потере соединения
- Оптимизация для работы в условиях нестабильной сети
- Поддержка TCP режима для стабильности

### AreaCalculator (MVP/area_calculation/area_calculation.py)

Класс для расчета площади объектов и процента наполнения:
- Детекция объектов с помощью YOLO модели
- Вычисление объединенной площади перекрывающихся объектов
- Расчет процента наполнения полок
- Фильтрация объектов по принадлежности к полкам

### ShowPicture (MVP/show_picture/show_picture.py)

Класс для визуализации результатов:
- Отображение видеопотока в реальном времени
- Визуализация bounding boxes обнаруженных объектов
- Отображение информации о проценте наполнения
- Поддержка масштабирования кадров

### ShelfCalibrator (MVP/outline_the_shelves/calibrate_shelf_coordinates.py)

Инструмент для калибровки координат полок:
- Интерактивное создание прямоугольников полок
- Сохранение координат в JSON файл
- Визуализация отмеченных полок

## Алгоритмы

### Sweepline Algorithm

Система использует алгоритм Sweepline для точного вычисления объединенной площади перекрывающихся прямоугольников. Это позволяет корректно обрабатывать случаи, когда объекты частично перекрывают друг друга.

Временная сложность: O(n² log n), где n - количество прямоугольников.

## Формат данных

### Координаты полок

Координаты представлены в формате `(x1, y1, x2, y2)`, где:
- `(x1, y1)` - левый верхний угол прямоугольника
- `(x2, y2)` - правый нижний угол прямоугольника

### Результаты детекции

Система возвращает словарь с результатами:
```python
{
    'total_objects_area': float,      # Общая площадь объектов (пиксели²)
    'shelf_total_area': float,        # Общая площадь полок (пиксели²)
    'fill_percentage': float,         # Процент наполнения (%)
    'num_objects': int,               # Количество обнаруженных объектов
    'objects_info': List[dict],       # Детальная информация об объектах
    'image_size': Tuple[int, int]    # Размер изображения (width, height)
}
```

## Управление

### Горячие клавиши

- `q` или `ESC` - выход из программы
- `Ctrl+C` - остановка обработки

### Калибровка полок

- Левая кнопка мыши - первый клик (начало полки), второй клик (конец полки)
- Правая кнопка мыши - отмена создания текущей полки
- `Delete` / `Backspace` - удалить последнюю полку
- `Escape` - отменить создание текущей полки
- `C` - очистить все полки
- `S` - сохранить координаты
- `L` - загрузить координаты

## Производительность

### Рекомендации по настройке

- **CONFIDENCE_THRESHOLD**: Начните с 0.25, увеличьте до 0.5-0.7 для уменьшения ложных срабатываний
- **DETECTION_IMG_SIZE**: Используйте 640 для быстрой обработки, 1280 для высокой точности
- **SKIP_FRAMES**: Увеличьте до 10-15 для слабых систем, уменьшите до 0-3 для мощных
- **MAX_DISPLAY_WIDTH**: Установите в соответствии с разрешением вашего монитора

## Устранение неполадок

### Проблемы с подключением к камере

1. Проверьте правильность IP адреса и порта
2. Убедитесь, что камера доступна в сети
3. Проверьте логин и пароль в `.env` файле
4. Убедитесь, что путь к RTSP потоку правильный

### Проблемы с детекцией

1. Проверьте, что модель загружена корректно
2. Убедитесь, что координаты полок заданы правильно
3. Попробуйте изменить `CONFIDENCE_THRESHOLD` в `config.py`
4. Проверьте качество изображения с камеры

### Проблемы с производительностью

1. Увеличьте `SKIP_FRAMES` для пропуска кадров
2. Уменьшите `DETECTION_IMG_SIZE`
3. Используйте GPU ускорение (CUDA)
4. Закройте другие ресурсоемкие приложения

## Лицензия

[Укажите лицензию проекта]

## Авторы

[Укажите авторов проекта]

## Дата создания

2026-01-27

